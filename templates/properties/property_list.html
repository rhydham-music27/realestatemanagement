{% extends 'base.html' %}
{% load static %}

{% block title %}Properties - Real Estate Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3">Available Properties</h1>
        <p class="text-muted">Showing {{ total_properties }} properties</p>
    </div>
    {% if user.is_authenticated %}
    <a href="{% url 'properties:property_create' %}" class="btn btn-primary">Add Property</a>
    {% endif %}
</div>
<!-- Filter panel -->
<div class="card mb-4 filter-panel">
  <div class="card-header p-0">
    <button class="btn btn-link w-100 text-start p-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel" aria-expanded="false" aria-controls="filterPanel">
      <i class="fas fa-filter"></i> Search &amp; Filter Properties
      {% if has_filters %}<span class="badge bg-primary ms-2">Filters Active</span>{% endif %}
    </button>
  </div>
  <div id="filterPanel" class="collapse {% if has_filters %}show{% endif %}">
    <div class="card-body">
      <form method="get" action="{% url 'properties:property_list' %}" id="filterForm" class="filter-form">
        <div class="row">
          <div class="col-md-6 mb-3">{{ filter_form.search.label_tag }}{{ filter_form.search }}</div>
          <div class="col-md-6 mb-3">{{ filter_form.property_type.label_tag }}{{ filter_form.property_type }}</div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">{{ filter_form.min_price.label_tag }}{{ filter_form.min_price }}</div>
          <div class="col-md-6 mb-3">{{ filter_form.max_price.label_tag }}{{ filter_form.max_price }}</div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">{{ filter_form.bedrooms.label_tag }}{{ filter_form.bedrooms }}</div>
          <div class="col-md-4 mb-3">{{ filter_form.bathrooms.label_tag }}{{ filter_form.bathrooms }}</div>
          <div class="col-md-4 mb-3">{{ filter_form.sort.label_tag }}{{ filter_form.sort }}</div>
        </div>
        <div class="filter-buttons d-flex gap-2">
          <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Apply Filters</button>
          <a href="{% url 'properties:property_list' %}" class="btn btn-outline-secondary"><i class="fas fa-times"></i> Clear Filters</a>
        </div>
      </form>
    </div>
  </div>
</div>

{% if has_filters %}
  <div class="active-filters mb-3">
    <strong>Active Filters:</strong>
    {% if request.GET.search %}
      <span class="badge bg-secondary filter-badge">Location: {{ request.GET.search }} <a href="?{% for key,value in query_params.items %}{% if key != 'search' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
    {% if request.GET.property_type %}
      <span class="badge bg-secondary filter-badge">Type: {{ request.GET.property_type }} <a href="?{% for key,value in query_params.items %}{% if key != 'property_type' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
    {% if request.GET.min_price %}
      <span class="badge bg-secondary filter-badge">Min Price: {{ request.GET.min_price }} <a href="?{% for key,value in query_params.items %}{% if key != 'min_price' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
    {% if request.GET.max_price %}
      <span class="badge bg-secondary filter-badge">Max Price: {{ request.GET.max_price }} <a href="?{% for key,value in query_params.items %}{% if key != 'max_price' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
    {% if request.GET.bedrooms %}
      <span class="badge bg-secondary filter-badge">Bedrooms: {{ request.GET.bedrooms }} <a href="?{% for key,value in query_params.items %}{% if key != 'bedrooms' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
    {% if request.GET.bathrooms %}
      <span class="badge bg-secondary filter-badge">Bathrooms: {{ request.GET.bathrooms }} <a href="?{% for key,value in query_params.items %}{% if key != 'bathrooms' and key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1" class="ms-2 text-white small">×</a></span>
    {% endif %}
  </div>
{% endif %}

{% if properties %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for property in properties %}
    <div class="col">
        <div class="card h-100 card-shadow">
            {% if property.featured_image %}
            <img src="{{ property.featured_image.url }}" class="card-img-top" alt="{{ property.title }}">
            {% else %}
            <img src="{% static 'images/placeholder-property.jpg' %}" class="card-img-top" alt="{{ property.title }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title text-truncate">{{ property.title }}</h5>
                <div class="mb-2">
                    <span class="badge bg-info me-1">{{ property.get_property_type_display }}</span>
                    <span class="badge bg-success">{{ property.get_status_display }}</span>
                </div>
                <p class="text-muted mb-1"><i class="fas fa-map-marker-alt"></i> {{ property.city }}, {{ property.state }}</p>
                <h4 class="text-primary mb-2">{{ property.formatted_price }}</h4>
                <div class="d-flex gap-3 mb-2 small text-muted">
                    <div><i class="fas fa-bed"></i> {{ property.bedrooms }}</div>
                    <div><i class="fas fa-bath"></i> {{ property.bathrooms }}</div>
                    <div><i class="fas fa-ruler-combined"></i> {{ property.area }} sq ft</div>
                </div>
                <p class="mb-3 text-truncate-2">{{ property.description|truncatewords:20 }}</p>
                <div class="mt-auto d-flex justify-content-between">
                    <a href="{% url 'properties:property_detail' property.pk %}" class="btn btn-outline-primary btn-sm">View Details</a>
                    <div>
                        {% if property.owner == user %}
                            <a href="{% url 'properties:property_update' property.pk %}" class="btn btn-sm btn-warning">Edit</a>
                            <a href="{% url 'properties:property_delete' property.pk %}" class="btn btn-sm btn-danger">Delete</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if is_paginated %}
<nav aria-label="Property pagination" class="mt-4">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% for key,value in query_params.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link" href="?{% for key,value in query_params.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
      </li>
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?{% for key,value in query_params.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <h4>No properties available</h4>
    <p class="text-muted">Check back later or add a new property.</p>
    {% if user.is_authenticated %}
    <a href="{% url 'properties:property_create' %}" class="btn btn-primary">Add Property</a>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
